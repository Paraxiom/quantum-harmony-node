# QuantumHarmony Node Operator
# One-command deployment for node operators
#
# Production Validators:
#   - Validator 1 (Montreal):    51.79.26.123  - 12D3KooWEyoppNCUx8Yx66oV9fJnriXwCcXwDDUA2kj6vnc6iDEp
#   - Validator 2 (Beauharnois): 51.79.26.168  - 12D3KooWHdiAxVd8uMQR1hGWXccidmfCwLqcMpGwR6QcTP6QRMuD
#   - Validator 3 (Frankfurt):   209.38.225.4  - 12D3KooWL3XJ9EMCyZvmmGXL2LMiVBtrVa2BuESsJiXkSj7333Jw
#
# Usage:
#   docker-compose up -d
#   docker-compose logs -f node

services:
  # =====================================================
  # CORE: QuantumHarmony Blockchain Node
  # =====================================================
  node:
    image: sylvaincormier/quantumharmony-node:latest
    platform: linux/amd64
    container_name: quantumharmony-node
    restart: unless-stopped
    user: "0:0"  # Run as root to ensure volume write permissions
    ports:
      - "9944:9944"   # RPC/WebSocket
      - "30333:30333" # P2P
      - "9615:9615"   # Prometheus metrics
    volumes:
      - node-data:/data
      - ./configs/chain-spec.json:/config/chainspec.json:ro
    command:
      - "--chain=/config/chainspec.json"
      - "--base-path=/data"
      - "--name=${NODE_NAME:-Operator}"
      - "--rpc-external"
      - "--rpc-cors=all"
      - "--rpc-methods=Unsafe"
      # IMPORTANT: Use reserved-nodes (NOT bootnodes) to avoid SelectNextSome crash
      - "--reserved-nodes=/ip4/51.79.26.123/tcp/30333/p2p/12D3KooWEyoppNCUx8Yx66oV9fJnriXwCcXwDDUA2kj6vnc6iDEp"
      - "--reserved-nodes=/ip4/51.79.26.168/tcp/30333/p2p/12D3KooWHdiAxVd8uMQR1hGWXccidmfCwLqcMpGwR6QcTP6QRMuD"
      - "--reserved-nodes=/ip4/209.38.225.4/tcp/30333/p2p/12D3KooWL3XJ9EMCyZvmmGXL2LMiVBtrVa2BuESsJiXkSj7333Jw"
    environment:
      - NODE_NAME=${NODE_NAME:-Operator}
    networks:
      - quantum-net
    healthcheck:
      test: ["CMD", "curl", "-sf", "http://localhost:9944/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s

  # =====================================================
  # DASHBOARD: Operator Web UI
  # =====================================================
  dashboard:
    image: nginx:alpine
    container_name: quantumharmony-dashboard
    restart: unless-stopped
    ports:
      - "8080:80"
    volumes:
      - ./dashboard:/usr/share/nginx/html:ro
      - ./configs/nginx-dashboard.conf:/etc/nginx/conf.d/default.conf:ro
    networks:
      - quantum-net
    depends_on:
      - node

  # =====================================================
  # PROXY: Nginx Reverse Proxy
  # =====================================================
  nginx:
    image: nginx:alpine
    container_name: quantumharmony-proxy
    restart: unless-stopped
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./configs/nginx.conf:/etc/nginx/nginx.conf:ro
      - ./certs:/etc/nginx/certs:ro
    networks:
      - quantum-net
    depends_on:
      - node
      - dashboard

networks:
  quantum-net:
    driver: bridge

volumes:
  node-data:
